#!/usr/bin/env python3
"""
md2pdf - Convert Markdown to PDF with Mermaid diagram rendering.

Usage:
    md2pdf <input.md> [--pdf <output.pdf>] [--svg-dir <dir>]

Renders mermaid code blocks to SVG using mmdc (mermaid-cli),
then converts the full document to PDF using weasyprint.
"""

import argparse
import hashlib
import os
import re
import subprocess
import sys
import tempfile
from pathlib import Path

import markdown
from pygments.formatters import HtmlFormatter
from weasyprint import HTML, CSS

MERMAID_PATTERN = re.compile(
    r'```mermaid\s*\n(.*?)```',
    re.DOTALL
)

CSS_STYLE = """
body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
    font-size: 11pt;
    line-height: 1.6;
    max-width: 800px;
    margin: 0 auto;
    padding: 2em;
}
h1, h2, h3, h4, h5, h6 {
    margin-top: 1.5em;
    margin-bottom: 0.5em;
}
h1 { font-size: 2em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
h2 { font-size: 1.5em; border-bottom: 1px solid #eee; padding-bottom: 0.3em; }
pre {
    background: #f6f8fa;
    padding: 1em;
    overflow-x: auto;
    border-radius: 6px;
    font-size: 0.9em;
}
code {
    background: #f6f8fa;
    padding: 0.2em 0.4em;
    border-radius: 3px;
    font-size: 0.9em;
}
pre code {
    background: none;
    padding: 0;
}
table {
    border-collapse: collapse;
    width: 100%;
    margin: 1em 0;
}
th, td {
    border: 1px solid #ddd;
    padding: 0.5em;
    text-align: left;
}
th {
    background: #f6f8fa;
}
img {
    max-width: 100%;
    height: auto;
}
.mermaid-diagram {
    text-align: center;
    margin: 1em 0;
}
.mermaid-diagram img {
    max-width: 100%;
}
"""


def render_mermaid_to_svg(mermaid_code: str, output_path: Path) -> bool:
    """Render mermaid code to SVG using mmdc."""
    with tempfile.NamedTemporaryFile(mode='w', suffix='.mmd', delete=False) as f:
        f.write(mermaid_code)
        input_path = f.name

    try:
        result = subprocess.run(
            ['mmdc', '-i', input_path, '-o', str(output_path), '-b', 'transparent'],
            capture_output=True,
            text=True
        )
        if result.returncode != 0:
            print(f"Warning: mermaid render failed: {result.stderr}", file=sys.stderr)
            return False
        return True
    except FileNotFoundError:
        print("Warning: mmdc not found. Install with: npm install -g @mermaid-js/mermaid-cli", file=sys.stderr)
        return False
    finally:
        os.unlink(input_path)


def process_markdown(md_content: str, svg_dir: Path) -> str:
    """Extract mermaid blocks, render to SVG, replace with img tags."""
    svg_dir.mkdir(parents=True, exist_ok=True)
    
    def replace_mermaid(match):
        mermaid_code = match.group(1)
        code_hash = hashlib.md5(mermaid_code.encode()).hexdigest()[:8]
        svg_name = f"diagram-{code_hash}.svg"
        svg_path = svg_dir / svg_name
        
        if render_mermaid_to_svg(mermaid_code, svg_path):
            return f'\n<div class="mermaid-diagram"><img src="{svg_path.absolute()}" alt="diagram"></div>\n'
        else:
            return f'\n<pre><code class="mermaid">{mermaid_code}</code></pre>\n'
    
    return MERMAID_PATTERN.sub(replace_mermaid, md_content)


def md_to_html(md_content: str) -> str:
    """Convert markdown to HTML."""
    md = markdown.Markdown(
        extensions=['tables', 'fenced_code', 'codehilite', 'toc'],
        extension_configs={
            'codehilite': {'css_class': 'highlight'}
        }
    )
    body = md.convert(md_content)
    pygments_css = HtmlFormatter().get_style_defs('.highlight')
    
    return f"""<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
{CSS_STYLE}
{pygments_css}
</style>
</head>
<body>
{body}
</body>
</html>
"""


def html_to_pdf(html_content: str, output_path: Path):
    """Convert HTML to PDF using weasyprint."""
    HTML(string=html_content).write_pdf(output_path)


def main():
    parser = argparse.ArgumentParser(description='Convert Markdown to PDF with Mermaid diagrams')
    parser.add_argument('input', help='Input markdown file')
    parser.add_argument('--pdf', help='Output PDF path (default: input with .pdf extension)')
    parser.add_argument('--svg-dir', help='Directory to save SVG diagrams (default: .tmp)')
    args = parser.parse_args()

    input_path = Path(args.input)
    if not input_path.exists():
        print(f"Error: {input_path} not found", file=sys.stderr)
        sys.exit(1)

    pdf_path = Path(args.pdf) if args.pdf else input_path.with_suffix('.pdf')
    svg_dir = Path(args.svg_dir) if args.svg_dir else Path('.tmp')

    md_content = input_path.read_text()
    processed_md = process_markdown(md_content, svg_dir)
    html_content = md_to_html(processed_md)
    html_to_pdf(html_content, pdf_path)

    print(f"Generated: {pdf_path}")
    print(f"SVGs in: {svg_dir}")


if __name__ == '__main__':
    main()
