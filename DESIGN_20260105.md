# AGT Architecture Design (2026-01-05)

This document describes the **current implemented architecture** of AGT
as of **2026-01-05**, based on the Rust code in `crates/agt`.

Where this document differs from `DESIGN_20260104.md`, this document is
intended to be authoritative for the current codebase.

---

## 1. Terminology

| Term            | World | Meaning |
|-----------------|-------|---------|
| **Session**     | Disk  | An agent run with a unique ID and a folder on disk. |
| **Session folder** | Disk | `sessions/<id>/` – directory tree that holds a sandbox worktree and tool state. |
| **Sandbox**     | Disk  | `sessions/<id>/sandbox/` – a git worktree where the agent runs. |
| **Shadow branch** | Git | `refs/heads/<branchPrefix><session_id>` (default prefix `agtsessions/`), used to store all agent commits and autocommits for a session. |
| **Shadow commit** | Git | A commit on the shadow branch. Autocommits are special shadow commits with two parents. |
| **Shadow tree** | Git | The tree object for a shadow commit, representing an entire session folder snapshot. |
| **Profile**     | Config | A named tool profile string recorded in session metadata (e.g. `default`). |

Unless otherwise stated:
- **User branch** means the git reference (e.g. `refs/heads/main`) from which the session was created.
- **Branch prefix** means `config.branch_prefix` (default `agtsessions/`).

---

## 2. High-Level Concept

AGT (Agent Git Tool) is a dual-mode git wrapper that provides:

- **Parallel agent sessions** in separate git worktrees under `sessions/<id>/sandbox/`.
- **Shadow branches** per session, keeping agent history separate from user branches.
- **Immutable snapshots** via autocommits that capture the entire session folder tree.
- **Filtering** so that agent branches/commits are hidden when AGT is invoked as `git`.

Key properties of the current implementation:

1. Each session has **one shadow branch**: `<branchPrefix><session_id>`.
2. The **sandbox worktree HEAD is the shadow branch**, not the user branch.
3. **User branches remain clean**: AGT does not update the user branch ref; it is only used as a reference parent for autocommits.
4. Autocommits create **two-parent commits** on the shadow branch:
   - Parent 1: previous shadow commit
   - Parent 2: current tip of the user branch

---

## 3. Repository Layout and `agt clone`

### 3.1 Clone Layout

`agt clone` creates a bare git repository and a managed working directory.

Current layout (simplified):

```text
parent-dir/
├── <repo_name>.git/        # Bare repository (git database)
└── <repo_name>/            # AGT-managed working area
    ├── main/               # Primary worktree (user-facing)
    └── sessions/           # Session folders live here
```

Notes:
- The bare repository is a **sibling directory** named `<repo_name>.git`, not a `.bare/` subdirectory.
- The `main/` directory is configured as a git worktree attached to the bare repo.
- The `sessions/` directory is reserved for session folders; AGT creates it as needed.

### 3.2 Configuration

AGT reads its configuration from:

- Global: `~/.agtconfig`
- Local: `.agt/config` in the repo root

Important keys (see `AgtConfig` in `crates/agt/src/config.rs`):

- `agt.gitPath` – path to the **real git binary** AGT will spawn.
- `agt.agentEmail` – email used for agent/autocommit authorship.
- `agt.branchPrefix` – prefix for shadow branches (default `agtsessions/`).

---

## 4. Session Lifecycle

### 4.1 Creating a Session – `agt session new`

Command:

```bash
agt session new [--id <id>] [--from <spec>] [--profile <name>]
```

Behavior:

1. **Session ID**  
   - If `--id` is omitted, AGT generates a new ID (e.g. `sess-YYYYMMDD-HHMMSS-xxxx`).

2. **Determine user branch**  
   - AGT resolves a **user branch reference** using `resolve_user_branch`:
     - If `--from <spec>` is provided:
       - First, AGT checks if `<spec>` refers to an existing session; if so it reuses that session’s user branch.
       - Otherwise, it interprets `<spec>` as a branch name or full ref and uses that.
     - If `--from` is omitted:
       - AGT uses the current `HEAD` branch of the bare repo (must be a non-detached, non-unborn head).

3. **Resolve starting commit (`start_commit`)**  
   - If `--from <spec>` is given and refers to a commit or session, AGT resolves that to a commit.
   - Otherwise, `start_commit` is the current `HEAD` commit of the bare repo.

4. **Create shadow branch**  
   - AGT creates a branch:
     - Name: `branch_name = branchPrefix + session_id`
     - Ref: `refs/heads/{branch_name}`
     - Target: `start_commit`

5. **Create session folder and sandbox worktree**  
   - Session root: `<repo_root>/sessions/<session_id>/`
   - The `SessionPaths` helper constructs:
     - `root` (session folder)
     - `sandbox = root.join("sandbox")`
     - `xdg_data = root.join("xdg")`
     - `xdg_config = root.join("config")`
   - AGT ensures these directories exist.
   - AGT then creates a git worktree:
     - `--git-dir` pointing at the bare repo common dir
     - `--worktree` pointing at `sandbox`
     - `--name` set to `session_id`
     - `--branch` set to `refs/heads/{branch_name}`
   - Result: inside `sandbox/`, `HEAD` points to the **shadow branch** `branchPrefix + session_id`.

6. **Session metadata and timestamps**  
   - AGT writes per-session metadata JSON under the bare repo:
     - `common_dir/agt/sessions/<session_id>.json`  
       Includes `session_id`, `branch` (shadow branch name), `sandbox` path, `from`, `from_spec`, `from_commit`, `user_branch`, `created_at`, `profile`, `isolation`.
   - AGT writes an initial timestamp file:
     - `common_dir/agt/timestamps/<session_id>`
     - Value: current Unix time in seconds at session creation.

7. **Profile**  
   - `--profile` (default: `default`) is stored in session metadata.
   - The profile string is available for isolation/sandbox tooling; current core autocommit logic does not branch on profile.

### 4.2 Forking a Session – `agt session fork`

Command:

```bash
agt session fork --from <existing-session-id> [--id <new-id>]
```

Behavior:

- Implemented as a thin wrapper around `create_session`:
  - `--from` is interpreted as a session ID.
  - The new session’s `start_commit` and `user_branch` are resolved from that existing session.
  - A new shadow branch and sandbox worktree are created for the new session.

Notes:
- There is legacy fork code in `commands/fork.rs` that is currently **unused**; the active implementation lives in `commands/session.rs`.

### 4.3 Exporting a Session – `agt session export`

Command:

```bash
agt session export [--session-id <id>]
```

Behavior:

1. Resolve session:
   - If `--session-id` is provided, AGT loads that session’s metadata.
   - Otherwise, AGT infers the session from the current working directory (`infer_session_from_cwd`).
2. Ensure the sandbox worktree exists and is clean:
   - Runs `git status --porcelain` in the sandbox using the configured `gitPath`.
   - Fails if there are uncommitted changes.
3. Determine current branch in sandbox:
   - Uses `gix::open` and inspects `HEAD`.
   - Rejects detached or unborn `HEAD`.
4. Push:
   - Executes `git push origin <current_branch_name>` from the sandbox directory using the real git binary.

Important:
- Export pushes the **current sandbox branch** (which is the shadow branch) to the remote.
- AGT itself does not automatically push or merge the user branch; integrating session work into user branches is a separate operation.

### 4.4 Removing a Session – `agt session remove`

Command:

```bash
agt session remove --id <id> [--delete-branch]
```

Behavior (via `prune_session`):

- Removes the session folder under `sessions/<id>/`.
- Removes the git worktree reference for that session.
- If `--delete-branch` is set, deletes the shadow branch `branchPrefix + id`.

---

## 5. Session Folder Layout

For a session with ID `<id>`:

```text
sessions/<id>/
├── sandbox/          # git worktree checked out on shadow branch
├── xdg/              # XDG_DATA_HOME-equivalent for tools
└── config/           # XDG_CONFIG_HOME-equivalent for tools
```

Notes:

- The **session folder root** is `sessions/<id>/`.
- The autocommit logic treats the entire session folder (not just `sandbox/`) as the snapshot root.
- There is currently **no `_` subdirectory or `_/index` file**; git index capture is not yet implemented.

---

## 6. Autocommit and Shadow Branch Topology

### 6.1 Command – `agt autocommit`

Command:

```bash
agt autocommit \
  --session-id <id> \
  [--timestamp <unix-epoch>] \
  [--dry-run] \
  [--siblings <comma-separated>]
```

Arguments:

- `--session-id`: required; identifies the session.
- `--timestamp`: optional override for the scan timestamp (non-negative Unix epoch).
- `--dry-run`: show what would be committed without writing a commit.
- `--siblings`: currently accepted but **unused** in the implementation; reserved for future directory selection.

### 6.2 Snapshot Root and Delta Computation

1. **Resolve session metadata**  
   - Reads `common_dir/agt/sessions/<session_id>.json` to get:
     - `sandbox` path
     - `user_branch` ref

2. **Determine session folder**  
   - Uses `sandbox` path from metadata.
   - If the path does not exist but the current working directory ends with `sandbox`, AGT uses the current directory.
   - The **session folder root** is `parent(sandbox)` (one directory up from `sandbox/`).

3. **Read timestamp**  
   - Reads `common_dir/agt/timestamps/<session_id>`.
   - If missing, defaults to `0`.
   - Effective scan timestamp:
     - If `--timestamp` is provided (and `>= 0`), that value is used.
     - Otherwise, the last stored timestamp is used.

4. **Resolve parent shadow commit**  
   - Shadow branch ref: `refs/heads/{branchPrefix}{session_id}`.
   - Parent 1 (`parent1`): current tip of shadow branch, peeled to a commit.

5. **Compute base paths**  
   - Walks `parent1`’s tree to collect all tracked paths into `base_paths`.

6. **Scan session folder for changes**  
   - Recursively walks the **session folder root** on disk (using `jwalk`).
   - Ignores `.git` directories.
   - For each file:
     - If `mtime >= threshold_time` (derived from the scan timestamp), the file is considered **changed**.
   - Deletions are any path in `base_paths` that is missing from the current scan.

Result: a `SnapshotDelta` describing:

- `changed`: map of relative paths (under session root) to absolute filesystem paths.
- `deleted`: set of relative paths that existed in the previous tree but not on disk.

### 6.3 Dry Run Mode

If `--dry-run` is set and there are changes:

- Prints a summary including counts and per-file `M`/`D` entries.
- Does **not** create a commit or update timestamps.

### 6.4 Commit Creation

When not in dry-run mode and there are changes:

1. **Resolve user branch parent (parent2)**  
   - Finds the user branch ref from session metadata (`user_branch`).
   - Resolves it to a commit (`parent2`).

2. **Validate sandbox HEAD**  
   - Opens the sandbox as a git repo with `gix::open`.
   - Fails if:
     - `HEAD` is detached.
     - `HEAD` is unborn.

3. **Build new tree**  
   - Starts from `parent1`’s tree.
   - Applies deletions and rewritten blobs/symlinks for all paths in `SnapshotDelta`.
   - Produces a new tree object ID.

4. **Create commit**  
   - Author/committer:
     - Name: `"agt"`
     - Email: `config.agent_email`
     - Time: current local/UTC time (`gix::date::Time::now_local_or_utc()`).
   - Commit:
     - Reference: `refs/heads/{branchPrefix}{session_id}`
     - Message: `"agt autocommit"`
     - Tree: snapshot tree built from the session folder.
     - Parents: `[parent1.id, parent2_id]`.

5. **Update timestamp**  
   - Writes the current Unix time (seconds) back to:
     - `common_dir/agt/timestamps/<session_id>`.

### 6.5 Shadow Branch Topology

For a given session `<id>`:

- Shadow branch: `refs/heads/{branchPrefix}{id}`.
- All autocommits and any manual commits in the sandbox occur on this branch.
- Autocommits form a linear history linked via parent1.
- Each autocommit also references the current user branch tip as parent2.
- The user branch itself is **not automatically updated** by AGT.

Conceptually:

```text
user branch (e.g. refs/heads/main):
    [A] --- [B] --- [C]  (unchanged by AGT)

shadow branch (refs/heads/agtsessions/<id>):
    [SC0] --- [SC1] --- [SC2] ...
       \         \         \
        \         \         \-- each points at current user branch tip as parent2
         \         \
          \-- parent2 = B/C/etc.
```

---

## 7. Filtering Behavior (git Mode)

When AGT is invoked in **git mode** (i.e. as `git`), it spawns the real git binary and filters output:

1. **Branch/Ref filtering**  
   - Lines referencing branches with the configured prefix (default `agtsessions/`) are hidden.
   - This affects commands like `git branch`, `git show-ref`, etc.

2. **Commit filtering**  
   - Commits authored with `agentEmail` (`config.agent_email`) are hidden from histories shown to the user in git mode.

3. **Bypass flag**  
   - `--disable-agt` can be used to bypass filtering and call real git directly.

In **agt mode** (invoked as `agt`), no filtering is applied; all branches and commits are visible.

---

## 8. CLI Commands (Summary)

Implemented commands (as of 2026-01-05):

- `agt clone <url> [--path <dir>]`  
  Clone a remote repository into the `<repo_name>.git` bare repo and `<repo_name>/` working area.

- `agt session new [--id <id>] [--from <spec>] [--profile <name>]`  
  Create a new session: shadow branch, session folder, and sandbox worktree.

- `agt session fork --from <session-id> [--id <new-id>]`  
  Fork an existing session using its user branch and starting commit.

- `agt session export [--session-id <id>]`  
  Push the current sandbox branch (typically the shadow branch) to `origin`.

- `agt session remove --id <id> [--delete-branch]`  
  Remove the session folder, worktree, and optionally delete the shadow branch.

- `agt autocommit --session-id <id> [--timestamp <t>] [--dry-run] [--siblings ...]`  
  Snapshot the entire session folder into a two-parent commit on the shadow branch.

- `agt status`  
  Shows AGT-specific status (implementation details in `commands/git_porcelain.rs` and related modules).

In addition, many git subcommands are supported via passthrough mode, with AGT spawning the real git binary and applying branch/commit filtering as described above.

---

## 9. Known Gaps vs Previous Design

Relative to `DESIGN_20260104.md`, the current implementation differs in several important ways:

1. **Bare repo layout**  
   - Implemented: `<repo_name>.git` as a sibling directory.  
   - Previous design: `.bare/` subdirectory inside the project root.

2. **Session folder contents**  
   - Implemented: `sessions/<id>/{sandbox, xdg, config}`.  
   - Previous design: referenced an additional `_/index` directory for git index capture, which does **not** exist today.

3. **Git index capture**  
   - Implemented: no special index capture; only timestamp-based filesystem scanning.  
   - Previous design: specified storing an index blob under `_/index`.

4. **siblings parameter**  
   - Implemented: `--siblings` is parsed but currently unused by `autocommit`; the entire session folder is always scanned.  
   - Previous design: suggested using siblings for more granular capture.

5. **Sandbox branch**  
   - Implemented: sandbox `HEAD` points at the **shadow branch** `branchPrefix + session_id`.  
   - Previous design: implied sandbox HEAD would remain on the user branch while shadow commits were separate. In practice, user branches stay untouched; shadow branches carry all session commits.

This document reflects the **actual behavior** of the code as of 2026-01-05 and should be kept in sync with future changes to the implementation.
