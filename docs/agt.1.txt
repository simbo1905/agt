AGT(1)                           User Commands                          AGT(1)

NAME
       agt - Agent Git Tool for immutable filesystem snapshots and session management

SYNOPSIS
       agt <command> [options]
       git [--disable-agt] <command> [options]

DESCRIPTION
       agt is a Git wrapper that provides dual-mode operation for managing AI
       agent coding sessions with immutable filesystem snapshots and time-travel
       capabilities.

       When invoked as 'git', agt spawns the real git binary and filters its
       stdout to hide agent branches, tags, and commits based on configuration.
       When invoked as 'agt', all branches and commits are visible, and additional
       agent management commands are available.

       The tool enables parallel agent workflows where multiple AI agents can work
       concurrently in isolated worktrees while maintaining a complete, immutable
       history of all file modifications. Agent branches are kept local and never
       pushed to remotes, while user branches follow standard Git workflows.

DUAL-MODE OPERATION
       git mode (filtered)
              When the binary is invoked as 'git' (via symlink or rename), it
              spawns the real git binary (configured via agt.gitPath) and filters
              the output:

              • Branches matching the configured prefix are hidden from output
              • Tags matching the configured prefix are hidden from output
              • Commits authored by the agent email are hidden from logs
              • All git commands are supported (full git compatibility)

       agt mode (unfiltered)
              When invoked as 'agt', no filtering is applied and additional
              commands are available for agent session management.

CONFIGURATION
       agt uses its own configuration files, separate from git's:

       ~/.agtconfig
              Global agt configuration file (equivalent to ~/.gitconfig).

       .agt/config
              Local repository agt configuration (stored in .agt/ not .git/).

       Configuration settings:

       agt.gitPath
              Path to the real git binary. Required when agt is invoked as 'git'.
              The real git should NOT be on PATH to prevent users accidentally
              using it directly. Example: /opt/git/bin/git

       agt.agentEmail
              Email address used for auto-commit operations. Commits by this
              author are filtered in git mode. Example: agt.opencode@local

       agt.branchPrefix
              Prefix for agent session branches. Branches and tags matching this
              prefix are filtered in git mode. Default: agtsessions/

       agt.userEmail
              The user's normal email for reference. Currently informational and
              reserved for future filtering/attribution features.

       Example configuration (~/.agtconfig):
              [agt]
                  gitPath = /opt/git/bin/git
                  agentEmail = agt.opencode@local
                  branchPrefix = agtsessions/
                  userEmail = simon@example.com

COMMANDS
   AGT-SPECIFIC COMMANDS (agt mode only)

       agt clone <remote-url> [--path <directory>]
              Clone a remote repository into an agt-managed structure. This command:

              1. Parses the git URL to extract org/repo
              2. Creates directory structure: <name>/
              3. Clones <remote-url> as a bare repository into <name>/.bare/
              4. Creates .git file pointing to .bare
              5. Creates main worktree: <name>/main/
              6. Initializes AGT metadata in .bare/agt/

              Result:
                  <name>/
                  ├── .bare/          # Bare repository (git database)
                  ├── .git            # Text file: "gitdir: .bare"
                  ├── main/           # Primary worktree (main branch)
                  │   └── .git        # Text file: "gitdir: ../.bare/worktrees/main"
                  └── sessions/       # Session folders created here

              Options:
                  --path <directory>    Target directory (default: current dir)

   SESSION COMMANDS

       agt session new [--id <id>] [-C <path>] [--from <ref>]
              Create a new agent session for a fresh ticket/task.

              1. Generates session ID (or uses provided --id)
              2. Resolves starting point (HEAD or --from)
              3. Creates shadow branch agtsessions/<id>
              4. Creates session folder at sessions/<id>/
              5. Creates sandbox (git worktree at sessions/<id>/sandbox/)
              6. Creates sibling folders based on profile (xdg/, config/)
              7. Initializes timestamp tracking for autocommits
              8. Records session metadata

              Session folder layout:
                  sessions/<id>/
                  ├── sandbox/        # Agent runs here (git worktree)
                  │   └── .git        # Points to ../../../.bare/worktrees/sandbox
                  ├── xdg/            # XDG_DATA_HOME (tool state)
                  ├── config/         # XDG_CONFIG_HOME (tool config)
                  └── _/              # AGT system folder

              Options:
                  --id <id>             Session identifier (default: generated UUID)
                  -C <path>             Repository path (default: current dir)
                  --from <ref>          Starting point: branch, commit, or tag
                                        (default: HEAD)
                  --profile <name>      Tool profile for folder setup (default: default)

       agt session export [-C <path>] [--session-id <id>]
              Push the user branch from a session's sandbox to the remote origin.

              1. Verifies no uncommitted changes in sandbox (fails if dirty)
              2. Gets current branch in sandbox
              3. Pushes branch to origin
              4. Reports success/failure

              Note: Shadow branches (agtsessions/*) are NEVER pushed to origin.
              Only user branches are exported.

              Options:
                  -C <path>             Repository path (default: current dir)
                  --session-id <id>     Session to export (default: detect from cwd)

       agt session remove --id <id> [-C <path>] [--delete-branch]
              Remove an agent session and clean up its resources.

              1. Removes session folder (sessions/<id>/)
              2. Removes git worktree
              3. Deletes shadow branch (agtsessions/<id>) if --delete-branch
              4. Cleans up session metadata

              Options:
                  --id <id>             Session to remove (required)
                  -C <path>             Repository path (default: current dir)
                  --delete-branch       Also delete the shadow branch

       agt session fork --from <id> [--id <new-id>] [-C <path>]
              Fork an existing session to create a parallel session.

              This is an advanced command for tools that support session forking
              (e.g., opencode). It creates a new session based on the current
              state of an existing session.

              1. Finds existing session <from>
              2. Creates new session based on current state
              3. New session gets its own shadow branch

              Options:
                  --from <id>           Source session ID (required)
                  --id <new-id>         New session ID (default: generated)
                  -C <path>             Repository path (default: current dir)

       agt session list [-C <path>]
              List all agent sessions with their status.

              Output includes:
              • Session ID
              • Shadow branch name
              • Sandbox path
              • Last commit timestamp
              • Number of shadow commits

              Options:
                  -C <path>             Repository path (default: current dir)

   AUTOCOMMIT COMMAND

       agt autocommit -C <path> --session-id <id> [--timestamp <epoch>]
              Create a shadow commit capturing the entire session state.

              This command:
              1. Reads last autocommit timestamp from .bare/agt/timestamps/<id>
              2. Scans the session folder for files with mtime >= last timestamp
              3. Builds shadow tree from session folder contents:
                 - sandbox/ (agent's code work)
                 - xdg/ (tool state)
                 - config/ (tool config)
                 - _/index (git index state)
              4. Creates shadow commit on agtsessions/<id> with:
                 - Parent 1: last commit on agtsessions/<id>
                 - Parent 2: current HEAD of user branch in sandbox
              5. Updates the timestamp file

              Note: The scan does not follow symlinks; symlink cycles are ignored.
              Note: Symlinks are stored as symlinks (mode 120000) with their target
                    path captured as-is.

              Options:
                  -C <path>             Session folder path (required)
                  --session-id <id>     Session identifier (required)
                  --timestamp <epoch>   Override scan timestamp (for testing)
                  --dry-run             Show what would be committed without committing

   STATUS COMMAND

       agt status [-C <path>]
              Show agt-specific status including:
              • Active sessions
              • Pending autocommits
              • Configuration summary

              Options:
                  -C <path>             Repository path (default: current dir)

   GIT COMMANDS (both modes)

       When invoked as 'git', agt spawns the real git binary (from agt.gitPath)
       and filters its stdout. All git commands are fully supported.

       In git mode, output is filtered according to agt configuration:
              • Branch listings hide branches matching agt.branchPrefix
              • Tag listings hide tags matching agt.branchPrefix
              • Log output hides commits by agt.agentEmail

       The filtering is line-based on stdout. Stderr is passed through unmodified.

       Examples:

       git branch
              Lists branches, excluding those matching agt.branchPrefix in git mode.

       git log
              Shows commit history, excluding commits by agt.agentEmail in git mode.

       git tag
              Lists tags, excluding those matching agt.branchPrefix in git mode.

OPTIONS
   GLOBAL OPTIONS

       --disable-agt
              When invoked as 'git', disable all agt filtering. Useful for
              debugging or when full visibility is needed without switching
              to agt mode.

       -C <path>
              Run as if git was started in <path> instead of current directory.
              Supported by both git and agt commands.

       --version
              Print version information.

       --help
              Print help for the command.

FILES
       ~/.agtconfig
              Global agt configuration. Contains [agt] section with gitPath,
              agentEmail, branchPrefix, etc.

       .agt/config
              Local repository agt configuration. Overrides global settings.
              Located in the project root (sibling to .bare/).

       .bare/agt/
              AGT state directory stored in the bare repository. Contains:

              timestamps/<session-id>
                     Last autocommit timestamp for each session (Unix epoch).

              sessions/<session-id>.json
                     Session metadata including user branch, creation time,
                     starting commit, and sandbox path.

       sessions/<session-id>/
              Session folder containing:
              - sandbox/ (git worktree where agent runs)
              - xdg/ (tool state, XDG_DATA_HOME)
              - config/ (tool config, XDG_CONFIG_HOME)
              - _/ (AGT system folder)

ENVIRONMENT
       AGT_DISABLE_FILTER
              If set to "1", disables filtering even in git mode. Equivalent
              to --disable-agt flag.

       AGT_DEBUG
              If set to "1", enables debug output showing filtering decisions.

       AGT_GIT_PATH
              Override agt.gitPath configuration. Path to the real git binary.

EXAMPLES
       Clone a remote repository:
              $ agt clone https://github.com/user/project.git
              $ cd project/main

       Configure agt settings (in ~/.agtconfig):
              [agt]
                  gitPath = /opt/git/bin/git
                  agentEmail = agt.opencode@local
                  branchPrefix = agtsessions/

       Start a new agent session:
              $ agt session new --id agent-001

       Work in the agent session (agent does its work):
              $ cd sessions/agent-001/sandbox
              $ # ... agent modifies files ...

       Auto-commit agent changes:
              $ agt autocommit -C sessions/agent-001 --session-id agent-001

       Export session work to remote:
              $ agt session export --session-id agent-001

       Fork a new session from an existing one (for parallel work):
              $ agt session fork --from agent-001 --id agent-002

       List all sessions:
              $ agt session list

       Remove a session:
              $ agt session remove --id agent-001 --delete-branch

       View all branches (including shadow branches):
              $ agt branch -a

       View filtered branches (user branches only):
              $ git branch -a

       Debug filtering issues:
              $ git --disable-agt branch -a

SANDBOXING ARCHITECTURE
       agt is designed to work with chroot jails (via toybox) to provide secure
       isolation for agent sessions.

       The Sandbox Model:
              1.  Each agent session runs in a dedicated sandbox folder.
              2.  The session is jailed using chroot, restricting filesystem access.
              3.  The 'agt' binary is bind-mounted into the jail as '/usr/bin/git'.
              4.  Profile-specific folders (xdg, config) are bind-mounted to
                  expected locations (~/.local/share, ~/.config).

       Dual-Role Security:
              Inside the jail (invoked as 'git'):
                     The agent sees a "normal" Git environment but is restricted
                     to user branches. It cannot see shadow branches or other
                     agent sessions.

              Outside the jail (invoked as 'agt'):
                     The process manager has full visibility. It executes
                     'agt autocommit' to capture the full state of the session
                     into the shadow branch.

ARCHITECTURE
       Repository Layout (after agt clone):
              project/
              ├── .bare/              # Bare repository (object store)
              ├── .git                # Text file: "gitdir: .bare"
              ├── main/               # Main user worktree
              │   └── .git            # File: "gitdir: ../.bare/worktrees/main"
              └── sessions/           # Agent session folders
                  └── agent-001/      # Session folder
                      ├── sandbox/    # Agent runs here (git worktree)
                      │   └── .git    # File: "gitdir: ../../../.bare/worktrees/sandbox"
                      ├── xdg/        # Tool state (XDG_DATA_HOME)
                      ├── config/     # Tool config (XDG_CONFIG_HOME)
                      └── _/          # AGT system folder
                          └── index   # Captured git index

       Shadow Commit Graph:
              User commits and shadow commits share the same object store.
              Shadow commits have two parents:
              - First parent: previous shadow commit (linear shadow history)
              - Second parent: user branch HEAD (linking to user timeline)

              This enables:
              • Full time-travel to any session state
              • Forking from any point in shadow history
              • Rolling back agent changes without affecting user branches
              • Comparing agent work against user branch state

       Shadow Tree Structure:
              The shadow tree mirrors the session folder exactly:
              (root)
              ├── sandbox/        # Agent's code (same as user branch tree)
              ├── xdg/            # Tool state snapshot
              ├── config/         # Tool config snapshot
              └── _/
                  └── index       # Git index at time of autocommit

EXIT STATUS
       0      Success

       1      General error

       2      Invalid command or options

       128    Git operation failed

SEE ALSO
       git(1), git-worktree(1)

BUGS
       Report bugs at: https://github.com/user/agt/issues

AUTHOR
       Written for AI agent session management and immutable filesystem workflows.

AGT 0.1.0                         January 2026                          AGT(1)
