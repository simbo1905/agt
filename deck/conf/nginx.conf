worker_processes 1;
error_log logs/error.log info;
pid logs/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /opt/homebrew/etc/openresty/mime.types;
    default_type application/octet-stream;

    access_log logs/access.log;

    lua_package_path "$prefix/lua/?.lua;/opt/homebrew/opt/openresty/site/lualib/?.lua;/opt/homebrew/opt/openresty/lualib/?.lua;;";
    lua_package_cpath "/opt/homebrew/opt/openresty/site/lualib/?.so;/opt/homebrew/opt/openresty/lualib/?.so;;";

    init_by_lua_block {
        require "resty.core"
        cjson = require "cjson"
    }

    upstream opencode_backend {
        server 127.0.0.1:4096;
        keepalive 16;
    }

    server {
        listen 8080;
        server_name localhost;

        location = / {
            default_type text/html;
            root html;
            index index.html;
        }

        location /api/projects {
            default_type application/json;
            content_by_lua_file lua/api_projects.lua;
        }

        location /api/sessions {
            default_type application/json;
            content_by_lua_file lua/api_sessions.lua;
        }

        location ~ ^/api/sessions/fork$ {
            default_type application/json;
            content_by_lua_file lua/api_session_fork.lua;
        }

        location ~ ^/api/sessions/([^/]+)/snapshots$ {
            default_type application/json;
            set $session_id $1;
            content_by_lua_file lua/api_snapshots.lua;
        }

        location ~ ^/api/sessions/([^/]+)/start$ {
            default_type application/json;
            set $session_id $1;
            content_by_lua_file lua/api_session_start.lua;
        }

        location ~ ^/api/sessions/([^/]+)/stop$ {
            default_type application/json;
            set $session_id $1;
            content_by_lua_file lua/api_session_stop.lua;
        }

        location ~ ^/api/sessions/([^/]+)/autocommit$ {
            default_type application/json;
            set $session_id $1;
            content_by_lua_file lua/api_session_autocommit.lua;
        }

        location ~ ^/api/sessions/([^/]+)$ {
            default_type application/json;
            set $session_id $1;
            content_by_lua_file lua/api_session_detail.lua;
        }

        location ~ ^/opencode/([^/]+)/(.*)$ {
            set $session_id $1;
            set $opencode_path $2;
            content_by_lua_file lua/proxy_opencode.lua;
        }

        location ~ ^/ws/([^/]+)$ {
            set $session_id $1;
            content_by_lua_file lua/proxy_websocket.lua;
        }

        location /static/ {
            root html;
        }
    }
}
